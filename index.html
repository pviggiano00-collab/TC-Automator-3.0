<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Generatore Protocolli TC ‚Äì Desio</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600&family=IBM+Plex+Sans:wght@300;400;500;600&display=swap');
:root {
  --bg:#0f1117; --surface:#1a1d27; --surface2:#22263a; --border:#2e3350;
  --accent:#4f8ef7; --accent2:#38d9a9; --text:#e8ecf4; --muted:#7a82a0;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{background:var(--bg);color:var(--text);font-family:'IBM Plex Sans',sans-serif;min-height:100vh;display:flex;flex-direction:column;}
header{padding:20px 36px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:14px;background:var(--surface);}
.logo{width:34px;height:34px;background:var(--accent);border-radius:7px;display:flex;align-items:center;justify-content:center;font-family:'IBM Plex Mono',monospace;font-weight:600;font-size:13px;color:#fff;}
header h1{font-size:17px;font-weight:600;}
header .sub{font-size:12px;color:var(--muted);font-family:'IBM Plex Mono',monospace;}
.badge{margin-left:auto;background:var(--surface2);border:1px solid var(--border);border-radius:20px;padding:4px 12px;font-size:11px;color:var(--accent2);font-family:'IBM Plex Mono',monospace;}
main{flex:1;padding:36px;max-width:1050px;margin:0 auto;width:100%;}
.step-label{font-family:'IBM Plex Mono',monospace;font-size:10px;color:var(--accent);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:6px;}
.step h2{font-size:19px;font-weight:500;margin-bottom:14px;}
.upload-zone{border:2px dashed var(--border);border-radius:12px;padding:44px;text-align:center;cursor:pointer;transition:all .2s;background:var(--surface);position:relative;}
.upload-zone:hover,.upload-zone.drag-over{border-color:var(--accent);background:var(--surface2);}
.upload-zone input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%;}
.upload-icon{font-size:38px;margin-bottom:10px;}
.upload-zone p{color:var(--muted);font-size:13px;}
.upload-zone strong{color:var(--accent);}
.btn{background:var(--accent);color:#fff;border:none;border-radius:8px;padding:11px 26px;font-size:13px;font-weight:600;cursor:pointer;font-family:'IBM Plex Sans',sans-serif;transition:all .15s;display:inline-flex;align-items:center;gap:7px;}
.btn:hover{background:#3a7ae8;transform:translateY(-1px);}
.btn-sec{background:var(--surface2);border:1px solid var(--border);color:var(--text);}
.btn-sec:hover{background:var(--border);}
.btn-green{background:#2a7a5a;} .btn-green:hover{background:#236b4d;}
#status{margin-top:14px;padding:11px 15px;border-radius:8px;font-size:12px;font-family:'IBM Plex Mono',monospace;display:none;}
#status.info{background:#1a2a4a;border:1px solid var(--accent);color:var(--accent);display:block;}
#status.success{background:#1a3a2a;border:1px solid var(--accent2);color:var(--accent2);display:block;}
#status.error{background:#3a1a1a;border:1px solid #f77;color:#f99;display:block;}
.patients-grid{display:grid;gap:10px;margin-top:14px;}
.patient-card{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:14px 18px;display:grid;grid-template-columns:180px 1fr 1fr;gap:14px;align-items:start;transition:border-color .2s;}
.patient-card:hover{border-color:var(--accent);}
.pname{font-weight:600;font-size:14px;}
.ptime{font-family:'IBM Plex Mono',monospace;font-size:11px;color:var(--accent2);margin-top:3px;}
.pfield label{font-size:10px;text-transform:uppercase;letter-spacing:1px;color:var(--muted);margin-bottom:3px;display:block;font-family:'IBM Plex Mono',monospace;}
.pfield p{font-size:12px;line-height:1.5;}
.tag{display:inline-block;background:var(--surface2);border:1px solid var(--border);border-radius:4px;padding:1px 7px;font-size:10px;font-family:'IBM Plex Mono',monospace;color:var(--accent);margin:2px 2px 2px 0;}
.actions{display:flex;gap:10px;margin-top:20px;flex-wrap:wrap;}
.divider{height:1px;background:var(--border);margin:28px 0;}
.privacy-note{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:11px 15px;font-size:11px;color:var(--muted);display:flex;align-items:flex-start;gap:9px;margin-bottom:20px;}
.privacy-note .icon{color:var(--accent2);font-size:15px;margin-top:-1px;flex-shrink:0;}
#pcount{font-family:'IBM Plex Mono',monospace;font-size:12px;color:var(--muted);margin-top:6px;}
.empty-state{text-align:center;padding:50px 20px;color:var(--muted);}
.empty-state .icon{font-size:44px;margin-bottom:10px;}
.empty-state p{font-size:13px;}
</style>
</head>
<body>
<header>
  <div class="logo">TC</div>
  <div>
    <h1>Generatore Protocolli TC</h1>
    <div class="sub">ASST Brianza ‚Äì Desio</div>
  </div>
  <div class="badge">üîí 100% locale ‚Äì nessun dato inviato</div>
</header>
<main>
  <div class="privacy-note">
    <span class="icon">üõ°Ô∏è</span>
    <span>Tutto il processing avviene <strong>esclusivamente nel tuo browser</strong>. Nessun dato paziente viene trasmesso a server esterni. Sicuro per reti ospedaliere.</span>
  </div>

  <div class="step" style="margin-bottom:28px">
    <div class="step-label">Step 01</div>
    <h2>Carica la lista giornaliera</h2>
    <div class="upload-zone" id="dropzone">
      <input type="file" id="pdf-input" accept=".pdf">
      <div class="upload-icon">üìã</div>
      <p>Trascina il PDF della lista esami, oppure <strong>clicca per selezionarlo</strong></p>
      <p style="margin-top:7px;font-size:11px;font-family:'IBM Plex Mono',monospace;">Formato: Lista esami da eseguire ‚Äì RIS Desio</p>
    </div>
    <div id="status"></div>
  </div>

  <div class="divider"></div>

  <div class="step">
    <div class="step-label">Step 02</div>
    <h2>Pazienti estratti</h2>
    <div id="pcount"></div>
    <div class="patients-grid" id="plist">
      <div class="empty-state"><div class="icon">‚¨ÜÔ∏è</div><p>Carica un PDF per vedere i pazienti estratti</p></div>
    </div>
    <div class="actions" id="actions" style="display:none">
      <button class="btn btn-green" onclick="generatePDF()">üñ®Ô∏è Genera protocolli compilabili</button>
      <button class="btn btn-sec" onclick="resetAll()">‚Ü∫ Ricomincia</button>
    </div>
  </div>
</main>

<script>
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
let patients = [];

// Drag & drop
const dropzone = document.getElementById('dropzone');
dropzone.addEventListener('dragover', e => { e.preventDefault(); dropzone.classList.add('drag-over'); });
dropzone.addEventListener('dragleave', () => dropzone.classList.remove('drag-over'));
dropzone.addEventListener('drop', e => { e.preventDefault(); dropzone.classList.remove('drag-over'); const f = e.dataTransfer.files[0]; if (f) processPDF(f); });
document.getElementById('pdf-input').addEventListener('change', e => { if (e.target.files[0]) processPDF(e.target.files[0]); });

function setStatus(msg, type) { const el = document.getElementById('status'); el.textContent = msg; el.className = type; }

async function processPDF(file) {
  setStatus('‚è≥ Lettura PDF in corso...', 'info');
  try {
    const ab = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({ data: ab }).promise;
    let fullText = '';

    for (let i = 1; i <= pdf.numPages; i++) {
      const page = await pdf.getPage(i);
      const content = await page.getTextContent();
      const items = content.items;

      // Group text items by Y coordinate (with tolerance) to reconstruct lines
      const lineMap = new Map();
      items.forEach(item => {
        if (!item.str || !item.str.trim()) return;
        const rawY = item.transform[5];
        let key = null;
        for (const [k] of lineMap) {
          if (Math.abs(k - rawY) <= 2) { key = k; break; }
        }
        if (key === null) key = rawY;
        if (!lineMap.has(key)) lineMap.set(key, []);
        lineMap.get(key).push({ x: item.transform[4], str: item.str });
      });

      // Sort top-to-bottom, join items left-to-right
      const sortedYs = [...lineMap.keys()].sort((a, b) => b - a);
      sortedYs.forEach(yKey => {
        const lineItems = lineMap.get(yKey).sort((a, b) => a.x - b.x);
        const lineText = lineItems.map(it => it.str).join(' ').replace(/\s+/g, ' ').trim();
        if (lineText) fullText += lineText + '\n';
      });
    }

    console.log('Extracted text (first 2000 chars):\n', fullText.slice(0, 2000));

    patients = parsePatients(fullText);
    if (patients.length === 0) { setStatus('‚ö†Ô∏è Nessun paziente trovato. Verifica il formato del PDF.', 'error'); return; }
    setStatus(`‚úì Estratti ${patients.length} pazienti con successo`, 'success');
    renderPatients(patients);
    document.getElementById('actions').style.display = 'flex';
  } catch(e) { setStatus('‚ùå Errore: ' + e.message, 'error'); console.error(e); }
}

// ‚îÄ‚îÄ PARSER ‚îÄ‚îÄ
function parsePatients(rawText) {
  const lines = rawText.split('\n').map(l => l.trim()).filter(l => l.length > 0);
  const startIdxs = [];
  lines.forEach((l, i) => { if (/^0D\d{8}/.test(l)) startIdxs.push(i); });
  const result = [];
  startIdxs.forEach((si, bi) => {
    const ei = bi + 1 < startIdxs.length ? startIdxs[bi + 1] : lines.length;
    const block = lines.slice(si, ei);
    const pt = parseBlock(block);
    if (pt && pt.name) {
      pt.hasContrast = pt.exams.some(e => /CONTRASTO|CON MDC|SENZA E CON/i.test(e));
      pt.hasThorax = pt.exams.some(e => /TORACE/i.test(e));
      result.push(pt);
    }
  });
  return result;
}

function parseBlock(lines) {
  const line0 = lines[0] || '';
  const line1 = lines[1] || '';
  const line2 = lines[2] || '';
  const line3 = lines[3] || '';

  // Time
  const timeM = line1.match(/(\d{2}:\d{2})/);
  const time = timeM ? timeM[1] : '';

  // Surname: between the two dates on line0
  // Fix: handle surname glued to DOB without space e.g. "FORMENTO30/08/1953"
  const line0fixed = line0.replace(/([A-Z√Ä√à√å√í√ô\'])(\d{2}\/\d{2}\/\d{4})/g, '$1 $2');
  const surnameM = line0fixed.match(/\d{2}\/\d{2}\/\d{4}\s+([A-Z√Ä√à√å√í√ô\'][A-Z√Ä√à√å√í√ô\'\s]*?)\s+\d{2}\/\d{2}\/\d{4}/);
  const surname = surnameM ? surnameM[1].trim() : '';

  const consumed = new Set();

  const NOISE_WORDS = new Set(['Nessuna','DESIO','Prenotato','Da eseguire','URG','1A','MEDICINA',
    'ONCOLOGI','ONE','CUP','DES-RAD','MDC URG','MDC 1A','MDC AP','TAC BASE','TAC C/S',
    'TAC DH','DIRETTA','ACCETTAZI','MAGGIORA','TA','AP','B-D','A']);
  const NOISE_RE = /^(0D|Codice|Descrizione|Stato esame|Tariffario|Dose|Lista esami|Richieste|errori|TAC \d|DESIO|DES-RAD|Prenotato|Nessuna|MDC|URG|1A|ONCOLOGI|ONE DIRETTA|DIRETTA|ACCETTAZI|CUP|TAC BASE|TAC C\/S|TAC DH|MEDICINA|MAGGIORA|\d{2}\/\d{2}\/\d{4}|\d{2}:\d{2}|\d{5,}|pviggiano|Of \d|^AP$|^TA$|^B-D)/i;

  // Given name: after HH:MM before DESIO on line1
  let given = '';
  const gm = line1.match(/\d{2}:\d{2}\s+(.*?)\s+DESIO/);
  if (gm) {
    given = gm[1].trim();
    // Scan lines 2-4 for name continuation (handles noise lines like "Nessuna" in between)
    for (let ci = 2; ci <= Math.min(4, lines.length - 1); ci++) {
      const cl = lines[ci] || '';
      // Pattern A: short frag + extra given name + noise: "O MARIA URG", "A SILVANA ONCOLOGI"
      const contA = cl.match(/^([A-Z√Ä√à√å√í√ô]{1,4})\s+([A-Z√Ä√à√å√í√ô][A-Z√Ä√à√å√í√ô]*)\s+(URG|Nessuna|MDC|TAC|ONE|DIRETTA|ONCOLOGI)/);
      // contA[1] can be a single letter like 'A' (name continuation) ‚Äî allow it even if in NOISE_WORDS
      if (contA && !NOISE_WORDS.has(contA[2])) {
        given = given + contA[1] + ' ' + contA[2]; consumed.add(ci); break;
      }
      // Pattern B: extra given name + noise: "TERESA MDC AP"
      const contB = cl.match(/^([A-Z√Ä√à√å√í√ô]{3,})\s+(MDC|URG|Nessuna|TAC|ONCOLOGI|ONE|DIRETTA)/);
      if (contB && !NOISE_WORDS.has(contB[1])) { given = given + ' ' + contB[1]; consumed.add(ci); break; }
      // Pattern C: short letter continuation only: "A ONCOLOGI..."
      const contC = cl.match(/^([A-Z√Ä√à√å√í√ô]{1,4})\s+(ONCOLOGI|MEDICINA|BASE|DH|C\/S|MDC|ONE|DIRETTA)/);
      if (contC) { given = given + contC[1]; consumed.add(ci); break; }
      // If line is pure noise, skip it and keep looking; otherwise stop
      if (!NOISE_WORDS.has(cl.trim()) && cl.trim().length > 1) break;
    }
  } else {
    // DESIO not visible on line1 ‚Äî name may be split
    const pm = line1.match(/\d{2}:\d{2}\s+([A-Z√Ä√à√å√í√ô][A-Z√Ä√à√å√í√ô\']*)/);
    if (pm) {
      given = pm[1];
      const cont2 = line2.match(/^(.+?)\s+DESIO/);
      if (cont2) { given = given + cont2[1].trim(); consumed.add(2); }
      else {
        const cont3 = line2.match(/^([A-Z√Ä√à√å√í√ô]{1,4})\s+(ONCOLOGI|MEDICINA|BASE|DH|MDC)/);
        if (cont3) { given = given + cont3[1]; consumed.add(2); }
      }
    }
  }

  // If first word of given is short (<=3 chars) and not noise, it's a surname continuation
  // e.g. surname=GALIMBER + given=TI NATALE -> surname=GALIMBERTI, given=NATALE
  // e.g. surname=BRACCIAL + given=E CARMINE -> surname=BRACCIALE, given=CARMINE
  // e.g. surname=FORMENTO + given=NI AUGUSTO -> surname=FORMENTONI, given=AUGUSTO
  let finalSurname = surname;
  const givenParts = given.trim().split(/\s+/).filter(p => p.length > 0);
  if (givenParts.length > 0) {
    const first = givenParts[0];
    if (first.length <= 3 && !NOISE_WORDS.has(first) && !/^(TAC|MDC|DES|ONE|CUP|URG|AP|TA)$/.test(first)) {
      finalSurname = surname + first;
      givenParts.shift();
    }
  }

  // Clean remaining given parts of noise
  const cleanGiven = givenParts.filter(p => !NOISE_WORDS.has(p) && !NOISE_RE.test(p));
  given = cleanGiven.join(' ');

  const name = (finalSurname + (given ? ' ' + given : '')).trim();
  return buildResult(name, time, lines, consumed, NOISE_WORDS, NOISE_RE);
}

function buildResult(name, time, lines, consumed, NOISE_WORDS, NOISE_RE) {
  // Indication
  let indication = '';
  lines.slice(2).forEach((line, idx) => {
    if (indication) return;
    if (consumed.has(idx + 2)) return;
    const l = line.trim();
    if (!l || l.length < 4) return;
    if (NOISE_WORDS.has(l)) return;
    if (NOISE_RE.test(l)) return;
    if (/^[A-Z]{1,3}\s+(ONCOLOGI|MEDICINA|BASE|DH|C\/S|MDC|AP|TA)/.test(l)) return;
    indication = l;
  });

  // Exams: TAC or TC ... Da eseguire
  const EXAM_EXCLUDE = /^TAC (2|BASE|C\/S|DH|ONCOLOG)/;
  const EXAM_PAT = /(?:[\w\.]+\s+)?((?:TAC|TC) [A-Z√Ä√à√å√í√ô][A-Z√Ä√à√å√í√ôA-Za-z\s,\(\)\.\/\-]+?)\s+Da eseguire/g;
  const blockText = lines.join('\n');
  const exams = [];
  let m;
  while ((m = EXAM_PAT.exec(blockText)) !== null) {
    const exam = m[1].trim();
    if (!EXAM_EXCLUDE.test(exam) && !exams.includes(exam)) exams.push(exam);
  }

  return { name, time, indication, exams };
}

function renderPatients(pts) {
  const c = document.getElementById('plist');
  c.innerHTML = '';
  document.getElementById('pcount').textContent = pts.length + ' pazienti trovati';
  pts.forEach(p => {
    const card = document.createElement('div');
    card.className = 'patient-card';
    const examsHtml = p.exams.map(e => `<span class="tag">${e}</span>`).join('') || '<span style="color:var(--muted)">‚Äî</span>';
    card.innerHTML = `
      <div><div class="pname">${p.name}</div><div class="ptime">‚è∞ ${p.time||'‚Äî'}</div></div>
      <div class="pfield"><label>Esami richiesti</label><p>${examsHtml}</p></div>
      <div class="pfield"><label>Quesito diagnostico</label><p>${p.indication||'<span style="color:var(--muted)">‚Äî</span>'}</p></div>`;
    c.appendChild(card);
  });
}

function resetAll() {
  patients = [];
  document.getElementById('plist').innerHTML = '<div class="empty-state"><div class="icon">‚¨ÜÔ∏è</div><p>Carica un PDF per vedere i pazienti estratti</p></div>';
  document.getElementById('actions').style.display = 'none';
  document.getElementById('status').className = '';
  document.getElementById('pcount').textContent = '';
  document.getElementById('pdf-input').value = '';
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// PDF GENERATION ‚Äì A4 landscape, 3 patients/page
// Layout: [Nome+Orario | Esami | Quesito] [Info Cliniche] [Basale] [Arteriosa] [Venosa] [Eq.Tardiva]
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function fitTextarea(ta) {
  const MIN_PT = 8, MAX_PT = 11;
  const PT_TO_PX = 1.3333;
  // Start at max, reduce until text fits, but never below min
  let size = MAX_PT;
  ta.style.fontSize = size + 'pt';
  while (size > MIN_PT && ta.scrollHeight > ta.clientHeight) {
    size -= 0.25;
    ta.style.fontSize = size + 'pt';
  }
  // If text fits with room to spare at max, keep at max (already set above if no overflow)
}

function generatePDF() {
  if (!patients.length) return;

  // Build a printable HTML page with fillable fields
  const dateStr = new Date().toLocaleDateString('it-IT');
  // Smart pagination: full rows = weight 3, compact rows = weight 1, page capacity = 9
  const PAGE_CAPACITY = 9;
  const pages = [];
  let currentPage = [];
  let currentWeight = 0;
  patients.forEach(pt => {
    const w = pt.hasContrast ? 3 : 1;
    if (currentWeight + w > PAGE_CAPACITY && currentPage.length > 0) {
      pages.push(currentPage);
      currentPage = [];
      currentWeight = 0;
    }
    currentPage.push(pt);
    currentWeight += w;
  });
  if (currentPage.length > 0) pages.push(currentPage);

  const rowsHtml = pages.map((batch, pi) => {
    const rowsInPage = batch.map(pt => pt.hasContrast ? buildPatientRow(pt) : buildCompactRow(pt)).join('');
    return `<div class="page">${rowsInPage}</div>`;
  }).join('');

  const html = `<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Protocolli TC ‚Äì ${dateStr}</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Arial&display=swap');
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: Arial, Helvetica, sans-serif; background: #fff; }
  @page {
    size: A4 landscape;
    margin: 5mm;
  }
  .page {
    width: 287mm;
    height: 190mm;
    display: flex; flex-direction: column;
    page-break-after: always;
    overflow: hidden;
  }
  .page-header {
    font-size: 7pt; color: #999; text-align: right;
    margin-bottom: 1mm;
  }
  .patient-row {
    flex: 1;
    display: flex;
    border: 0.3pt solid #aaa;
    margin-bottom: 1mm;
    overflow: hidden;
  }
  .patient-row:last-child { margin-bottom: 0; }

  /* Compact row for no-contrast patients */
  .patient-row-compact {
    display: flex;
    border: 0.3pt solid #bbb;
    border-left: 3pt solid #a0a0a0;
    margin-bottom: 1mm;
    height: 18mm;
    min-height: 18mm;
    max-height: 18mm;
    overflow: hidden;
    background: #fafafa;
  }
  .patient-row-compact:last-child { margin-bottom: 0; }
  .compact-info {
    flex: 1;
    display: flex;
    align-items: center;
    padding: 0 3mm;
    gap: 4mm;
    overflow: hidden;
  }
  .compact-name {
    min-width: 42mm; max-width: 42mm;
  }
  .compact-name .name { font-size: 8pt; font-weight: bold; color: #222; }
  .compact-name .time { font-size: 6.5pt; color: #666; margin-top: 0.5mm; }
  .compact-exams {
    flex: 1;
    font-size: 6pt;
    color: #333;
    line-height: 1.4;
  }
  .compact-quesito {
    min-width: 55mm; max-width: 55mm;
    font-size: 6.5pt;
    color: #333;
    line-height: 1.3;
  }
  .compact-quesito .qlabel {
    font-size: 5pt; font-weight: bold; color: #999;
    text-transform: uppercase; letter-spacing: 0.3pt;
    margin-bottom: 0.5mm;
  }
  .compact-hrtc {
    min-width: 28mm; max-width: 28mm;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 2mm;
    border-left: 0.2pt solid #ddd;
    padding: 0 3mm;
  }
  .compact-hrtc .hlabel { font-size: 8pt; font-weight: bold; color: #2d6a4f; }
  .compact-hrtc .checkbox {
    width: 5mm; height: 5mm;
    border: 0.5pt solid #2d6a4f;
    background: #f0faf5;
    flex-shrink: 0;
  }
  .compact-noaction {
    min-width: 28mm; max-width: 28mm;
    display: flex; align-items: center; justify-content: center;
    border-left: 0.2pt solid #ddd;
    padding: 0 3mm;
  }
  .compact-noaction span { font-size: 6pt; color: #bbb; font-style: italic; }

  /* Column widths */
  .col-patient { width: 48mm; min-width: 48mm; display: flex; flex-direction: column; border-right: 0.2pt solid #ccc; }
  .col-info    { flex: 1; display: flex; flex-direction: column; border-right: 0.2pt solid #ccc; }
  .col-phase   { width: 38mm; min-width: 38mm; display: flex; flex-direction: column; border-right: 0.2pt solid #ccc; }
  .col-phase:last-child { border-right: none; }

  /* Headers */
  .col-header {
    font-size: 9pt; font-weight: bold; color: white;
    text-align: center; padding: 1mm;
    white-space: nowrap; overflow: hidden;
  }
  .hdr-green  { background: #2d6a4f; }
  .hdr-blue   { background: #1e3a5f; }
  .hdr-red    { background: #7b2d2d; }

  /* Patient col internals */
  .cell-name {
    background: #dceee4; padding: 1.5mm;
    border-bottom: 0.2pt solid #ccc;
    flex-shrink: 0;
  }
  .cell-name .name { font-size: 11pt; font-weight: bold; }
  .cell-name .time { font-size: 9pt; color: #555; margin-top: 1mm; }
  .cell-exams {
    background: #fff; padding: 1.5mm;
    border-bottom: 0.2pt solid #ccc;
    flex-shrink: 0;
  }
  .cell-exams p { font-size: 7.5pt; line-height: 1.4; color: #222; }
  .cell-quesito {
    background: #f5f5f5; padding: 1.5mm;
    flex: 1;
  }
  .cell-quesito .label { font-size: 6.5pt; font-weight: bold; color: #888; text-transform: uppercase; letter-spacing: 0.3pt; }
  .cell-quesito .text  { font-size: 9pt; font-weight: bold; color: #111; margin-top: 1mm; line-height: 1.3; }

  /* Info cliniche internals */
  .info-body { flex: 1; padding: 1.5mm; display: flex; flex-direction: column; gap: 1.5mm; }
  .info-row { display: flex; align-items: center; gap: 1.5mm; }
  .info-label { font-size: 9pt; font-weight: bold; color: #777; white-space: nowrap; }
  .info-row input[type=text] {
    flex: 1; height: 5mm;
    border: 0.3pt solid #b0b8d0;
    border-radius: 1pt;
    background: #f8f9ff;
    font-size: 10.5pt; padding: 0 1mm;
    outline: none;
    font-family: Arial, Helvetica, sans-serif;
  }
  .info-row input[type=text]:focus { border-color: #4f8ef7; background: #fff; }
  .altre-info-wrap { flex: 1; display: flex; flex-direction: column; }
  .altre-info-wrap .info-label { margin-bottom: 1mm; }
  textarea.altre-info {
    flex: 1; width: 100%;
    border: 0.3pt solid #b0b8d0;
    border-radius: 1pt;
    background: #f8f9ff;
    font-size: 11pt;
    padding: 1mm;
    resize: none; outline: none;
    font-family: Arial, Helvetica, sans-serif;
    line-height: 1.4;
    overflow: hidden;
  }
  textarea.altre-info:focus { border-color: #4f8ef7; background: #fff; }

  /* Phase col internals */
  .phase-body { flex: 1; padding: 1.5mm; display: flex; flex-direction: column; }
  .flu-row { display: flex; align-items: center; gap: 1mm; font-size: 6pt; color: #666; margin-bottom: 1mm; }
  .flu-row input { flex: 1; height: 4mm; border: 0.2pt solid #ccc; background: #f8f8f8; font-size: 6pt; padding: 0 0.5mm; }
  .flu-row input:focus { border-color: #4f8ef7; outline: none; }
  .flu-sep { border-top: 0.2pt solid #ddd; margin: 1mm 0; }
  .district-list { flex: 1; display: flex; flex-direction: column; justify-content: space-around; }
  .district-row { display: flex; align-items: center; justify-content: space-between; padding: 0.5mm 0; }
  .district-row .dlabel { font-size: 8pt; font-weight: bold; color: #111; }
  .district-row .checkbox {
    width: 4mm; height: 4mm;
    border: 0.4pt solid #888;
    background: #fcfcfc;
    flex-shrink: 0;
  }
  /* Tardiva */
  .tardiva-list { flex: 1; display: flex; flex-direction: column; justify-content: space-around; }
  .tardiva-row { display: flex; align-items: center; gap: 1mm; }
  .tardiva-row .dlabel { font-size: 8pt; font-weight: bold; color: #111; width: 8mm; }
  .tardiva-row .tlabel { font-size: 7pt; color: #555; }
  .tardiva-row input { flex: 1; height: 4mm; border: 0.2pt solid #ccc; background: #f8f8f8; font-size: 6.5pt; padding: 0 0.5mm; }
  .tardiva-row input:focus { border-color: #4f8ef7; outline: none; }
  .angio-row { margin-top: 1mm; border-top: 0.3pt solid #ddd; padding-top: 1mm; }

  @media print {
    * { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    body { background: white; }
    .toolbar { display: none !important; }
    .page { page-break-after: always; page-break-inside: avoid; }
    .patient-row { page-break-inside: avoid; overflow: hidden; }
    input, textarea { border-color: #b0b8d0 !important; background: #f8f9ff !important; }
    .print-btn { display: none !important; }
  }
</style>
</head>
<body>
<div class="toolbar" style="text-align:center; padding: 8px; background:#1a1d27; color:#e8ecf4; font-family:sans-serif; font-size:13px; display:flex; align-items:center; justify-content:center; gap:12px;">
  <button class="print-btn" onclick="window.parent.document.getElementById('print-frame').remove()" style="background:#444;color:white;border:none;border-radius:6px;padding:6px 14px;font-size:13px;cursor:pointer;">
    ‚Üê Torna
  </button>
  <strong>Protocolli TC ‚Äì ${dateStr}</strong>
  <button class="print-btn" onclick="window.print()" style="background:#4f8ef7;color:white;border:none;border-radius:6px;padding:6px 18px;font-size:13px;cursor:pointer;font-weight:600;">
    üñ®Ô∏è Stampa / Salva PDF
  </button>
  <small style="color:#7a82a0;">Compila i campi, poi stampa</small>
</div>
${rowsHtml}
</body>
</html>`;

  // Write into a hidden iframe and print from it ‚Äî works on GitHub Pages
  let iframe = document.getElementById('print-frame');
  if (iframe) iframe.remove();
  iframe = document.createElement('iframe');
  iframe.id = 'print-frame';
  iframe.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;border:none;z-index:9999;background:white;';
  document.body.appendChild(iframe);
  iframe.contentDocument.open();
  iframe.contentDocument.write(html);
  iframe.contentDocument.close();

  // Auto-fit font size for all "Altre info" textareas
  iframe.addEventListener('load', () => {
    const iDoc = iframe.contentDocument;
    iDoc.querySelectorAll('textarea.altre-info').forEach(ta => {
      fitTextarea(ta);
      ta.addEventListener('input', () => fitTextarea(ta));
    });
  });
  // Also run after short delay to ensure layout is complete
  setTimeout(() => {
    const iDoc = iframe.contentDocument;
    if (iDoc) iDoc.querySelectorAll('textarea.altre-info').forEach(ta => {
      fitTextarea(ta);
      ta.addEventListener('input', () => fitTextarea(ta));
    });
  }, 300);
  setStatus(`‚úì ${patients.length} pazienti caricati. Compila i campi e usa il pulsante Stampa.`, 'success');
}

function buildCompactRow(pt) {
  const examsHtml = pt.exams.map(e => `<div>${e}</div>`).join('');
  const hrtcSection = pt.hasThorax
    ? `<div class="compact-hrtc">
        <span class="hlabel">HRTC</span>
        <div class="checkbox"></div>
       </div>`
    : `<div class="compact-noaction"><span>‚Äî</span></div>`;
  return `
  <div class="patient-row-compact">
    <div class="compact-info">
      <div class="compact-name">
        <div class="name">${pt.name}</div>
        ${pt.time ? `<div class="time">‚è∞ Ore ${pt.time}</div>` : ''}
      </div>
      <div class="compact-exams">${examsHtml}</div>
      <div class="compact-quesito">
        <div class="qlabel">Quesito</div>
        <div>${pt.indication || '‚Äî'}</div>
      </div>
    </div>
    ${hrtcSection}
  </div>`;
}

function buildPatientRow(pt) {
  const examsHtml = pt.exams.map(e => `<p>${e}</p>`).join('');
  const uid = Math.random().toString(36).slice(2,8);
  return `
  <div class="patient-row">
    <!-- Paziente -->
    <div class="col-patient">
      <div class="col-header hdr-green">PAZIENTE / ESAMI / QUESITO</div>
      <div class="cell-name">
        <div class="name">${pt.name}</div>
        ${pt.time ? `<div class="time">‚è∞ Ore ${pt.time}</div>` : ''}
      </div>
      <div class="cell-exams">${examsHtml}</div>
      <div class="cell-quesito">
        <div class="label">Quesito diagnostico</div>
        <div class="text">${pt.indication || '‚Äî'}</div>
      </div>
    </div>
    <!-- Info cliniche -->
    <div class="col-info">
      <div class="col-header hdr-green">INFO CLINICHE</div>
      <div class="info-body">
        <div class="info-row">
          <span class="info-label">TC prec?</span>
          <input type="text" placeholder="">
        </div>
        <div class="info-row">
          <span class="info-label">GFR?</span>
          <input type="text" placeholder="">
        </div>
        <div class="altre-info-wrap">
          <div class="info-label">Altre info:</div>
          <textarea class="altre-info" placeholder="Incolla qui le note cliniche..."></textarea>
        </div>
      </div>
    </div>
    <!-- Basale -->
    <div class="col-phase">
      <div class="col-header hdr-green">BASALE</div>
      <div class="phase-body">
        <div class="district-list">
          ${['ENC','Collo','ADs','ADc','TAs','TAc'].map(d => `
          <div class="district-row">
            <span class="dlabel">${d}</span>
            <div class="checkbox"></div>
          </div>`).join('')}
        </div>
      </div>
    </div>
    <!-- Arteriosa -->
    <div class="col-phase">
      <div class="col-header hdr-blue">ARTERIOSA</div>
      <div class="phase-body">
        <div class="flu-row"><span>Flu.</span><input type="text"></div>
        <div class="flu-row"><span>Vol.</span><input type="text"></div>
        <div class="flu-sep"></div>
        <div class="district-list">
          ${['ADs','ADc','TAs','TAc','Collo TAs','Collo TAc'].map(d => `
          <div class="district-row">
            <span class="dlabel">${d}</span>
            <div class="checkbox"></div>
          </div>`).join('')}
          <div class="district-row angio-row">
            <span class="dlabel">Angio TC</span>
            <div class="checkbox"></div>
          </div>
        </div>
      </div>
    </div>
    <!-- Venosa -->
    <div class="col-phase">
      <div class="col-header hdr-blue">VENOSA</div>
      <div class="phase-body">
        <div class="flu-row"><span>Flu.</span><input type="text"></div>
        <div class="flu-row"><span>Vol.</span><input type="text"></div>
        <div class="flu-sep"></div>
        <div class="district-list">
          ${['ADs','ADc','TAs','TAc','Collo TAs','Collo TAc'].map(d => `
          <div class="district-row">
            <span class="dlabel">${d}</span>
            <div class="checkbox"></div>
          </div>`).join('')}
        </div>
      </div>
    </div>
    <!-- EQ. Tardiva -->
    <div class="col-phase">
      <div class="col-header hdr-red">EQ. TARDIVA</div>
      <div class="phase-body">
        <div class="tardiva-list">
          ${['ADs','ADc','TAs','TAc'].map(d => `
          <div class="tardiva-row">
            <span class="dlabel">${d}</span>
            <span class="tlabel">min</span>
            <input type="text">
          </div>`).join('')}
          <div class="tardiva-row">
            <span class="dlabel">ENC</span>
            <span class="tlabel">min</span>
            <input type="text">
          </div>
        </div>
      </div>
    </div>
  </div>`;
}

function drawRow(doc, pt, y, rH, PW, M) {
  const W = PW - M * 2;
  const iH = rH - 1.5;
  const x = M;

  // Column widths (mm)
  const cLeft = 48;   // nome+esami+quesito
  const cInfo = 80;   // info cliniche (dominant column)
  const cPh = (W - cLeft - cInfo) / 4; // 4 phases (minimal checkboxes)

  const HDR = 5.5;
  const bodyY = y + HDR;
  const bodyH = iH - HDR;

  // Color palette
  const G=[45,106,79], B=[30,58,95], R=[123,45,45];
  const LG=[220,237,228], LB=[210,225,245], LR=[245,210,210];
  const LGRAY=[248,248,248], MGRAY=[195,195,195], DGRAY=[90,90,90], BLK=[15,15,15];

  // Outer border
  doc.setDrawColor(160,160,160); doc.setLineWidth(0.3);
  doc.rect(x, y, W, iH);

  // ‚îÄ‚îÄ HEADER ROW ‚îÄ‚îÄ
  // Left cols header (green)
  doc.setFillColor(...G); doc.rect(x, y, cLeft + cInfo, HDR, 'F');
  // Phase headers
  [[G,0],[B,1],[B,2],[R,3]].forEach(([col,i]) => {
    doc.setFillColor(...col);
    doc.rect(x + cLeft + cInfo + i * cPh, y, cPh, HDR, 'F');
  });
  doc.setFontSize(5.8); doc.setFont('helvetica','bold'); doc.setTextColor(255,255,255);
  doc.text('PAZIENTE / ESAMI / QUESITO', x + cLeft/2, y + HDR/2 + 1, {align:'center'});
  doc.text('INFO CLINICHE', x + cLeft + cInfo/2, y + HDR/2 + 1, {align:'center'});
  ['BASALE','ARTERIOSA','VENOSA','EQ. TARDIVA'].forEach((lbl,i) => {
    doc.text(lbl, x + cLeft + cInfo + (i+0.5)*cPh, y + HDR/2 + 1, {align:'center'});
  });

  // ‚îÄ‚îÄ LEFT COLUMN (3 sub-sections) ‚îÄ‚îÄ
  const nameH = bodyH * 0.30;
  const examH = bodyH * 0.28;
  const questH = bodyH - nameH - examH;

  // Name section
  doc.setFillColor(...LG); doc.rect(x, bodyY, cLeft, nameH, 'F');
  doc.setFontSize(7.5); doc.setFont('helvetica','bold'); doc.setTextColor(...BLK);
  const nLines = doc.splitTextToSize(pt.name, cLeft - 3);
  doc.text(nLines.slice(0,2), x + 1.5, bodyY + 4);
  if (pt.time) {
    doc.setFontSize(6); doc.setFont('helvetica','normal'); doc.setTextColor(...DGRAY);
    doc.text('Ore ' + pt.time, x + 1.5, bodyY + nameH - 2);
  }

  doc.setDrawColor(...MGRAY); doc.setLineWidth(0.15);
  doc.line(x, bodyY + nameH, x + cLeft, bodyY + nameH);

  // Exam section
  doc.setFillColor(255,255,255); doc.rect(x, bodyY + nameH, cLeft, examH, 'F');
  doc.setFontSize(4.5); doc.setFont('helvetica','normal'); doc.setTextColor(...BLK);
  if (pt.exams.length) {
    const eLines = doc.splitTextToSize(pt.exams.join('\n'), cLeft - 3);
    doc.text(eLines.slice(0,6), x + 1.5, bodyY + nameH + 3.5);
  }

  doc.setDrawColor(...MGRAY); doc.line(x, bodyY + nameH + examH, x + cLeft, bodyY + nameH + examH);

  // Quesito section
  doc.setFillColor(...LGRAY); doc.rect(x, bodyY + nameH + examH, cLeft, questH, 'F');
  doc.setFontSize(4.5); doc.setFont('helvetica','bold'); doc.setTextColor(...DGRAY);
  doc.text('QUESITO DIAGNOSTICO', x + 1.5, bodyY + nameH + examH + 2.8);
  doc.setFontSize(7.5); doc.setFont('helvetica','bold'); doc.setTextColor(...BLK);
  const qLines = doc.splitTextToSize(pt.indication || '‚Äî', cLeft - 3);
  doc.text(qLines.slice(0,5), x + 1.5, bodyY + nameH + examH + 6);

  // ‚îÄ‚îÄ INFO CLINICHE ‚îÄ‚îÄ
  const iX = x + cLeft;
  doc.setFillColor(255,255,255); doc.rect(iX, bodyY, cInfo, bodyH, 'F');
  doc.setDrawColor(...MGRAY); doc.setLineWidth(0.2);
  doc.line(iX, y, iX, y + iH);

  const fieldPad = 1.5;
  const fieldX = iX + fieldPad;
  const fieldW = cInfo - fieldPad * 2;
  let iy = bodyY + 2;

  doc.setFontSize(5.8); doc.setFont('helvetica','bold'); doc.setTextColor(...DGRAY);

  // TC prec
  doc.text('TC prec?', fieldX, iy + 3.5);
  doc.setFillColor(248,250,255);
  doc.setDrawColor(180,180,200); doc.setLineWidth(0.2);
  doc.rect(fieldX + 14, iy, fieldW - 14, 5.5, 'FD');
  iy += 8;

  // GFR
  doc.text('GFR?', fieldX, iy + 3.5);
  doc.setFillColor(248,250,255);
  doc.rect(fieldX + 10, iy, fieldW - 10, 5.5, 'FD');
  iy += 8;

  // Altre info - large empty box
  doc.text('Altre info:', fieldX, iy + 3.5);
  iy += 6;
  const altreH = bodyH - (iy - bodyY) - 2;
  doc.setFillColor(248,250,255);
  doc.setDrawColor(180,180,200); doc.setLineWidth(0.2);
  doc.rect(fieldX, iy, fieldW, altreH, 'FD');

  // ‚îÄ‚îÄ PHASE COLUMNS ‚îÄ‚îÄ
  const districts = ['ENC','Collo','ADs','ADc','TAs','TAc'];
  const phaseBg = [LG, LB, LB, LR];
  const phaseXs = [0,1,2,3].map(i => x + cLeft + cInfo + i * cPh);

  phaseXs.forEach((px, pi) => {
    doc.setFillColor(...phaseBg[pi]);
    doc.rect(px, bodyY, cPh, bodyH, 'F');
    doc.setDrawColor(...MGRAY); doc.setLineWidth(0.25);
    doc.line(px, y, px, y + iH);

    const lblX = px + 1.5;
    const cbSz = 3;
    const cbX = px + cPh - cbSz - 1.5;
    let cy = bodyY + 3;

    // Arteriosa & Venosa: Flu/Vol lines
    if (pi === 1 || pi === 2) {
      doc.setFontSize(7); doc.setFont('helvetica','normal'); doc.setTextColor(...DGRAY);
      doc.text('Flu.', lblX, cy + 2.2);
      doc.setLineWidth(0.15); doc.setDrawColor(175,175,175);
      doc.line(lblX + 6.5, cy + 2.2, px + cPh - 1.5, cy + 2.2);
      cy += 4.5;
      doc.text('Vol.', lblX, cy + 2.2);
      doc.line(lblX + 6.5, cy + 2.2, px + cPh - 1.5, cy + 2.2);
      cy += 4.5;
      doc.setDrawColor(...MGRAY); doc.setLineWidth(0.15);
      doc.line(px, cy - 0.5, px + cPh, cy - 0.5);
    }

    // EQ. TARDIVA: special layout with min fields
    if (pi === 3) {
      const minD = ['ADs','ADc','TAs','TAc'];
      const sp = bodyH / (minD.length + 1.5);
      minD.forEach((d, di) => {
        const ry = bodyY + 3 + di * sp;
        doc.setFontSize(8); doc.setFont('helvetica','bold'); doc.setTextColor(...BLK);
        doc.text(d, lblX, ry + 2.2);
        doc.text('min', lblX + 7.5, ry + 2.2);
        doc.setLineWidth(0.15); doc.setDrawColor(175,175,175);
        doc.line(lblX + 14, ry + 2.2, px + cPh - 1.5, ry + 2.2);
      });
      // ENC checkbox
      const encY = bodyY + 3 + minD.length * sp;
      doc.setFontSize(8); doc.setFont('helvetica','bold'); doc.setTextColor(...BLK);
      doc.text('ENC', lblX, encY + 2.2);
      doc.setFillColor(252,252,252); doc.setDrawColor(130,130,130); doc.setLineWidth(0.3);
      doc.rect(cbX, encY + 0.3, cbSz, cbSz, 'FD');
      return;
    }

    // Normal districts with checkboxes
    const avail = bodyH - (cy - bodyY);
    const sp2 = avail / districts.length;
    districts.forEach((d, di) => {
      const ry = cy + di * sp2;
      doc.setFontSize(8); doc.setFont('helvetica','bold'); doc.setTextColor(...BLK);
      doc.text(d, lblX, ry + 2.5);
      doc.setFillColor(252,252,252); doc.setDrawColor(130,130,130); doc.setLineWidth(0.3);
      doc.rect(cbX, ry + 0.3, cbSz, cbSz, 'FD');
    });
  });

  // Close right border
  doc.setDrawColor(160,160,160); doc.setLineWidth(0.3);
  doc.line(x + W, y, x + W, y + iH);
}
</script>
</body>
</html>